

name:  site
# This workflow is triggered by 'ready' branches 

on:
  workflow_dispatch:
  push:
    branches: 
      - '[0-9]*'
      
jobs:
  restore:
    name: Restore artifact
    runs-on: ubuntu-latest
    outputs:
      artifact-found: ${{ steps.restore-step.outputs.artifact-found }}
    permissions:
      statuses: write 
      actions: read
    steps:

      - name: Checkout
        uses: actions/checkout@v4
         
      - name: Restore if artifact exists
        id: restore-step
        env:
           GH_TOKEN: ${{ secrets.READY_PUSHER }}
        run: |
          set -x
          set +e
          ARTIFACT=site-${{ github.sha }}
          gh run download -R ${{ github.repository }} -D _site -n $ARTIFACT > restore.log 2>&1
          result=$?
          set -e
          set +x
          cat restore.log
          if [ $result -eq 0 ]; then result_icon=âœ…; else result_icon=ðŸ¤·â€â™‚ï¸; fi
          echo "## $result_icon \`restore artifact\`"                      >> $GITHUB_STEP_SUMMARY
          echo '```'                                                       >> $GITHUB_STEP_SUMMARY
          cat restore.log                                                  >> $GITHUB_STEP_SUMMARY
          echo '```'                                                       >> $GITHUB_STEP_SUMMARY
          if [ $result -eq 0 ]; then
            echo "Restored \`_site\` using artifact \`$ARTIFACT\`" >> $GITHUB_STEP_SUMMARY
            echo "artifact-found=true" >> $GITHUB_OUTPUT
          else
            echo "No \`$ARTIFACT\` artifact found - will build from scratch" >> $GITHUB_STEP_SUMMARY
            echo "artifact-found=false" >> $GITHUB_OUTPUT
          fi
          exit 0

  prepare-image:
    needs: [restore]
    if: needs.restore.outputs.artifact-found != 'true'
    name: Fetch or Build
    permissions:
      packages: write
    uses: lakruzz/workflows/.github/workflows/docker_with_cache.yml@experimental
    with:
      dockerfile: dockerfile
      hash-files: Gemfile.lock
      image-tag: docker-workflow-image

  jekyll-build:
    name: Jekyll Build
    needs: [prepare-image, restore]
    if: needs.restore.outputs.artifact-found != 'true'
    permissions:
      statuses: write
      contents: read
      packages: read
      actions: write
    uses: lakruzz/workflows/.github/workflows/rake_task.yml@experimental
    secrets:
      token: ${{ secrets.READY_PUSHER }}
    with:
      rake-task: jekyll:build
      image-fqdn: ${{ needs.prepare-image.outputs.image-fqdn }}
      upload-artifact: true        
          

