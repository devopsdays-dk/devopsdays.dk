name: Release to Production

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+' # Matches: 0.9.0, 1.2.3
      - '[a-zA-Z]+[0-9]+.[0-9]+.[0-9]+' # Matches: v1.0.0, ver1.0.0, RC1.0.0
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v1.0.0 or 1.0.0)"
        required: true
        type: string

concurrency:
  group: "production-pages"
  cancel-in-progress: false

jobs:
  verify-tag-on-main:
    name: Verify tag is on main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main branch
        env:
          TAG_NAME: ${{ github.ref_name || inputs.tag }}
        run: |
          # Get the commit hash of the tag
          tag_commit=$(git rev-list -n 1 $TAG_NAME)

          # Get the commit hash of main
          main_commit=$(git rev-list -n 1 origin/main)

          # Check if tag commit is an ancestor of main
          if ! git merge-base --is-ancestor $tag_commit origin/main; then
            echo "❌ Tag $TAG_NAME is not on the main branch!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ Tag $TAG_NAME verified on main branch" >> $GITHUB_STEP_SUMMARY

  deploy-to-prod:
    name: Deploy to Production
    needs: verify-tag-on-main
    permissions:
      contents: read
    uses: lakruzz/workflows/.github/workflows/deploy-to-repo.yml@experimental
    with:
      target_repository: devopsdays-dk/devopsdays-dk.github.io
      artifact_name: site-${{ github.sha }}
      user_name: "Production Deployer"
      user_email: "deploy@devopsdays.dk"
      cname: "www.devopsdays.dk"
    secrets:
      token: ${{ secrets.READY_PUSHER }}