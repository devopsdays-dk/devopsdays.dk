name: Release to Production

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Matches v1.0.0, v1.2.3, etc.

concurrency:
  group: "production-pages"
  cancel-in-progress: false

jobs:

  verify-tag-on-main:
    name: Verify tag is on main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify tag is on main branch
        run: |
          # Get the commit hash of the tag
          tag_commit=$(git rev-list -n 1 ${{ github.ref_name }})
          
          # Get the commit hash of main
          main_commit=$(git rev-list -n 1 origin/main)
          
          # Check if tag commit is an ancestor of main
          if ! git merge-base --is-ancestor $tag_commit origin/main; then
            echo "❌ Tag ${{ github.ref_name }} is not on the main branch!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "✅ Tag ${{ github.ref_name }} verified on main branch" >> $GITHUB_STEP_SUMMARY

  deploy-to-prod:
    name: Deploy to Production
    needs: verify-tag-on-main
    permissions:
      contents: read
    uses: ./.github/workflows/deploy-to-repo.yml
    with:
      target_repository: devopsdays-dk/devopsdays-dk.github.io
      artifact_name: site-${{ github.sha }}
      user_name: "Production Deployer"
      user_email: "deploy@devopsdays.dk"
      commit_message: "Production release: ${{ github.ref_name }}"
    secrets:
      token: ${{ secrets.PROD_DEPLOY_TOKEN }}
